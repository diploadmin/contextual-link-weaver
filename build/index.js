(()=>{"use strict";var e={n:t=>{var n=t&&t.__esModule?()=>t.default:()=>t;return e.d(n,{a:n}),n},d:(t,n)=>{for(var o in n)e.o(n,o)&&!e.o(t,o)&&Object.defineProperty(t,o,{enumerable:!0,get:n[o]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)};const t=window.wp.plugins,n=window.wp.editPost,o=window.wp.components,i=window.wp.i18n,r=window.wp.element,s=window.wp.data,l=window.wp.apiFetch;var a=e.n(l);const c=window.wp.richText,d=window.wp.blockEditor,p=window.ReactJSXRuntime;(0,c.registerFormatType)("contextual-link-weaver/suggest",{title:(0,i.__)("Link Weaver Suggestion","contextual-link-weaver"),tagName:"a",className:null,edit:({value:e,onChange:t,isActive:n,contentRef:l})=>{const[x,g]=(0,r.useState)(!1),[h,m]=(0,r.useState)(!1),[k,w]=(0,r.useState)([]),[v,_]=(0,r.useState)(""),[f,b]=(0,r.useState)(""),y=(0,r.useRef)(),j=(0,s.useSelect)(e=>e("core/editor").getCurrentPostId(),[]),S=void 0!==e.start&&void 0!==e.end&&e.start!==e.end,T=(0,r.useCallback)(()=>{if(!S)return;const t=e.text.slice(e.start,e.end).trim();t&&(b(t),g(!0),m(!0),w([]),_(""),a()({path:"/contextual-link-weaver/v1/link-for-text",method:"POST",data:{anchor_text:t,post_id:j}}).then(e=>{w(Array.isArray(e)?e:[]),m(!1)}).catch(e=>{_(e.message||(0,i.__)("An error occurred.","contextual-link-weaver")),m(!1)}))},[S,e,j]),z=(0,r.useCallback)(n=>{t((0,c.applyFormat)(e,{type:"core/link",attributes:{href:n,url:n}})),g(!1),w([])},[e,t]),B=(0,r.useCallback)(()=>{g(!1),w([]),_("")},[]);return(0,p.jsxs)(p.Fragment,{children:[(0,p.jsx)("span",{ref:y,children:(0,p.jsx)(d.RichTextToolbarButton,{icon:"admin-links",title:(0,i.__)("Link Weaver â€” find link for selection","contextual-link-weaver"),onClick:T,isActive:n})}),x&&(0,p.jsx)(o.Popover,{anchor:y.current,placement:"bottom-start",onClose:B,focusOnMount:!1,children:(0,p.jsxs)("div",{style:u.popover,children:[(0,p.jsxs)("div",{style:u.popoverHeader,children:[(0,p.jsx)("strong",{style:u.popoverTitle,children:(0,i.__)("Links for:","contextual-link-weaver")}),(0,p.jsxs)("em",{style:u.popoverAnchor,children:["â€ž",f,'"']}),(0,p.jsx)("button",{onClick:B,style:u.closeBtn,"aria-label":(0,i.__)("Close","contextual-link-weaver"),children:"âœ•"})]}),h&&(0,p.jsxs)("div",{style:u.loadingRow,children:[(0,p.jsx)(o.Spinner,{}),(0,p.jsx)("span",{style:u.loadingText,children:(0,i.__)("Searching for best linksâ€¦","contextual-link-weaver")})]}),v&&(0,p.jsx)("p",{style:u.errorText,children:v}),!h&&!v&&0===k.length&&(0,p.jsx)("p",{style:u.emptyText,children:(0,i.__)("No matching posts found.","contextual-link-weaver")}),k.map((e,t)=>(0,p.jsxs)("div",{style:{...u.suggestionItem,borderTop:t>0?"1px solid #f0f0f0":"none",paddingTop:t>0?"12px":"0",marginTop:t>0?"12px":"0"},children:[(0,p.jsx)("p",{style:u.suggestionTitle,children:e.title}),(0,p.jsx)("p",{style:u.suggestionReason,children:e.reasoning}),(0,p.jsx)(o.Button,{variant:"primary",__next40pxDefaultSize:!0,onClick:()=>z(e.url),children:(0,i.__)("Insert Link","contextual-link-weaver")})]},t))]})})]})}});const x=()=>(0,p.jsx)("span",{className:"dashicons dashicons-admin-links"});(0,t.registerPlugin)("link-weaver-plugin",{render:()=>{const[e,t]=(0,r.useState)(!1),[l,c]=(0,r.useState)([]),[d,g]=(0,r.useState)(""),{postContent:h,currentPostId:m,blocks:k}=(0,s.useSelect)(e=>({postContent:e("core/editor").getEditedPostContent(),currentPostId:e("core/editor").getCurrentPostId(),blocks:e("core/block-editor").getBlocks()}),[]),{replaceBlocks:w}=(0,s.useDispatch)("core/block-editor");return(0,p.jsxs)(p.Fragment,{children:[(0,p.jsx)(n.PluginSidebarMoreMenuItem,{target:"link-weaver-sidebar",icon:(0,p.jsx)(x,{}),children:(0,i.__)("Link Weaver","contextual-link-weaver")}),(0,p.jsx)(n.PluginSidebar,{name:"link-weaver-sidebar",title:(0,i.__)("Link Weaver","contextual-link-weaver"),children:(0,p.jsxs)(o.PanelBody,{title:(0,i.__)("Link Suggestions","contextual-link-weaver"),children:[(0,p.jsx)("p",{style:{fontSize:"12px",color:"#666",marginBottom:"12px"},children:(0,i.__)("Scan the entire post and get up to 5 internal link suggestions.","contextual-link-weaver")}),(0,p.jsx)("p",{style:{fontSize:"12px",color:"#666",marginBottom:"12px"},children:(0,i.__)("Tip: select any phrase in the editor and click the ðŸ”— toolbar button to find a link just for that text.","contextual-link-weaver")}),(0,p.jsx)(o.Button,{variant:"primary",__next40pxDefaultSize:!0,onClick:()=>{h&&0!==h.trim().length?(t(!0),g(""),c([]),a()({path:"/contextual-link-weaver/v1/suggestions",method:"POST",data:{content:h,post_id:m}}).then(e=>{Array.isArray(e)?c(e):g((0,i.__)("The API returned an unexpected format.","contextual-link-weaver")),t(!1)}).catch(e=>{g(e.message||(0,i.__)("An unknown error occurred.","contextual-link-weaver")),t(!1)})):g((0,i.__)("Cannot generate suggestions for an empty post.","contextual-link-weaver"))},isBusy:e,children:e?(0,i.__)("Generatingâ€¦","contextual-link-weaver"):(0,i.__)("Scan Post & Generate","contextual-link-weaver")}),e&&(0,p.jsx)(o.Spinner,{style:{marginTop:"10px"}}),d&&(0,p.jsx)("p",{style:{color:"red",marginTop:"10px",fontSize:"12px"},children:d}),l&&l.length>0&&(0,p.jsxs)("div",{style:{marginTop:"20px"},children:[(0,p.jsx)("h4",{style:{marginBottom:"10px",fontSize:"13px"},children:(0,i.__)("Suggestions:","contextual-link-weaver")}),(0,p.jsx)("ul",{style:{listStyle:"none",margin:0,padding:0},children:l.map((e,t)=>(0,p.jsxs)("li",{style:u.sidebarItem,children:[(0,p.jsxs)("p",{style:{margin:"0 0 6px 0",fontSize:"13px"},children:[(0,p.jsx)("strong",{children:(0,i.__)("Phrase:","contextual-link-weaver")}),(0,p.jsx)("br",{}),(0,p.jsxs)("em",{children:["â€ž",e.anchor_text,'"']})]}),(0,p.jsxs)("p",{style:{margin:"0 0 10px 0",fontSize:"12px",color:"#555"},children:[(0,p.jsx)("strong",{children:(0,i.__)("Link to:","contextual-link-weaver")}),(0,p.jsx)("br",{}),e.title]}),(0,p.jsx)(o.Button,{variant:"secondary",__next40pxDefaultSize:!0,onClick:()=>((e,t)=>{let n=!1,o=null;const i=k.map(i=>{if(n||!i.attributes.content)return i;let r="";if("string"==typeof i.attributes.content)r=i.attributes.content;else{if("object"!=typeof i.attributes.content||!i.attributes.content.originalHTML)return i;r=i.attributes.content.originalHTML}const s=`<a href="${t}" class="clw-inserted-link">${e}</a>`;if(r.includes(e)&&!r.includes(s)){const t=r.replace(e,s),l={...i.attributes,content:t};return o=i.clientId,n=!0,{...i,attributes:l}}return i});if(n&&o){const t=document.querySelector(".editor-styles-wrapper");t&&new MutationObserver((e,t)=>{const n=document.querySelector(`[data-block="${o}"]`);if(n){n.scrollIntoView({behavior:"smooth",block:"center"});const e=n.querySelector("a.clw-inserted-link");e&&(e.classList.add("clw-highlight-link"),e.classList.remove("clw-inserted-link")),t.disconnect()}}).observe(t,{childList:!0,subtree:!0}),w(k.map(e=>e.clientId),i),c(l.filter(t=>t.anchor_text!==e))}else alert(`Could not find the exact phrase "${e}" in your content. It might be split across multiple paragraphs.`)})(e.anchor_text,e.url),children:(0,i.__)("Insert Link","contextual-link-weaver")})]},t))})]})]})})]})}});const u={popover:{padding:"16px",minWidth:"300px",maxWidth:"380px",fontSize:"13px"},popoverHeader:{display:"flex",flexWrap:"wrap",alignItems:"baseline",gap:"6px",marginBottom:"12px",paddingBottom:"10px",borderBottom:"1px solid #e0e0e0",position:"relative",paddingRight:"24px"},popoverTitle:{fontSize:"12px",color:"#666",fontWeight:"normal"},popoverAnchor:{fontSize:"13px",fontWeight:"600",color:"#1e1e1e"},closeBtn:{position:"absolute",top:0,right:0,background:"none",border:"none",cursor:"pointer",fontSize:"14px",color:"#888",padding:"0",lineHeight:1},loadingRow:{display:"flex",alignItems:"center",gap:"10px",padding:"8px 0"},loadingText:{fontSize:"12px",color:"#666"},errorText:{color:"#cc1818",fontSize:"12px",margin:"8px 0"},emptyText:{color:"#888",fontSize:"12px",margin:"8px 0"},suggestionItem:{paddingBottom:"4px"},suggestionTitle:{margin:"0 0 4px 0",fontWeight:"600",fontSize:"13px",color:"#1e1e1e"},suggestionReason:{margin:"0 0 10px 0",fontSize:"11px",color:"#888",lineHeight:"1.5"},sidebarItem:{border:"1px solid #ddd",padding:"12px",borderRadius:"4px",marginBottom:"10px"}}})();