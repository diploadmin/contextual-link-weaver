(()=>{"use strict";var e={n:t=>{var n=t&&t.__esModule?()=>t.default:()=>t;return e.d(n,{a:n}),n},d:(t,n)=>{for(var r in n)e.o(n,r)&&!e.o(t,r)&&Object.defineProperty(t,r,{enumerable:!0,get:n[r]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)};const t=window.wp.plugins,n=window.wp.editPost,r=window.wp.components,o=window.wp.i18n,i=window.wp.element,s=window.wp.data,l=window.wp.apiFetch;var a=e.n(l);const c=window.wp.richText,d=window.wp.blockEditor,p=window.ReactJSXRuntime;(0,c.registerFormatType)("contextual-link-weaver/suggest",{title:(0,o.__)("Link Weaver Suggestion","contextual-link-weaver"),tagName:"span",className:"clw-suggestion",edit:({value:e,onChange:t,isActive:n})=>{const[l,x]=(0,i.useState)(!1),[g,h]=(0,i.useState)(""),[m,v]=(0,i.useState)(!1),[k,w]=(0,i.useState)([]),[y,f]=(0,i.useState)(""),[b,j]=(0,i.useState)(!1),[_,S]=(0,i.useState)([]),[T,L]=(0,i.useState)(""),B=(0,i.useRef)(),C=(0,s.useSelect)(e=>e("core/editor").getCurrentPostId(),[]),I=void 0!==e.start&&void 0!==e.end&&e.start!==e.end,P=(0,i.useCallback)(()=>{if(!I)return;const t=e.text.slice(e.start,e.end).trim();t&&(h(t),x(!0),v(!0),j(!0),w([]),S([]),f(""),L(""),a()({path:"/contextual-link-weaver/v1/link-for-text",method:"POST",data:{anchor_text:t,post_id:C}}).then(e=>{w(Array.isArray(e)?e:[])}).catch(e=>{f(e.message||"LLM error")}).finally(()=>{v(!1)}),a()({path:"/contextual-link-weaver/v1/link-from-rag",method:"POST",data:{query:t}}).then(e=>{S(Array.isArray(e)?e:[])}).catch(e=>{L(e.message||"RAG error")}).finally(()=>{j(!1)}))},[I,e,C]),z=(0,i.useCallback)(n=>{t((0,c.applyFormat)(e,{type:"core/link",attributes:{href:n,url:n}})),x(!1)},[e,t]),A=(0,i.useCallback)(()=>{x(!1),w([]),S([]),f(""),L("")},[]);return(0,p.jsxs)(p.Fragment,{children:[(0,p.jsx)(d.BlockControls,{group:"other",children:(0,p.jsx)(r.ToolbarGroup,{children:(0,p.jsx)("span",{ref:B,children:(0,p.jsx)(r.ToolbarButton,{icon:"superhero",label:(0,o.__)("Link Weaver — find link","contextual-link-weaver"),onClick:P,isActive:l})})})}),l&&(0,p.jsx)(r.Popover,{anchor:B.current,placement:"bottom-start",onClose:A,focusOnMount:!1,children:(0,p.jsxs)("div",{style:u.popover,children:[(0,p.jsxs)("div",{style:u.popoverHeader,children:[(0,p.jsx)("strong",{style:u.popoverTitle,children:(0,o.__)("Links for:","contextual-link-weaver")}),(0,p.jsxs)("em",{style:u.popoverAnchor,children:["„",g,"“"]}),(0,p.jsx)("button",{onClick:A,style:u.closeBtn,"aria-label":"Close",children:"✕"})]}),(0,p.jsxs)("div",{style:u.section,children:[(0,p.jsxs)("div",{style:u.sectionHeader,children:[(0,p.jsx)("span",{style:u.sectionLabel,children:(0,o.__)("Knowledge Base Sources","contextual-link-weaver")}),b&&(0,p.jsx)(r.Spinner,{style:{margin:0}})]}),T&&(0,p.jsx)("p",{style:u.errorText,children:T}),!b&&!T&&0===_.length&&(0,p.jsx)("p",{style:u.emptyText,children:(0,o.__)("No sources found.","contextual-link-weaver")}),_.map((e,t)=>(0,p.jsxs)("div",{style:{...u.suggestionItem,borderTop:t>0?"1px solid #f0f0f0":"none",paddingTop:t>0?"10px":"0",marginTop:t>0?"10px":"0"},children:[(0,p.jsx)("p",{style:u.suggestionTitle,children:e.title}),e.text&&(0,p.jsx)("p",{style:u.suggestionReason,children:e.text}),(0,p.jsx)(r.Button,{variant:"primary",isSmall:!0,onClick:()=>z(e.url),children:(0,o.__)("Insert Link","contextual-link-weaver")})]},"rag-"+t))]}),(0,p.jsxs)("div",{style:{...u.section,marginTop:"16px"},children:[(0,p.jsxs)("div",{style:u.sectionHeader,children:[(0,p.jsx)("span",{style:u.sectionLabel,children:(0,o.__)("Internal Posts (LLM)","contextual-link-weaver")}),m&&(0,p.jsx)(r.Spinner,{style:{margin:0}})]}),y&&(0,p.jsx)("p",{style:u.errorText,children:y}),!m&&!y&&0===k.length&&(0,p.jsx)("p",{style:u.emptyText,children:(0,o.__)("No matching posts found.","contextual-link-weaver")}),k.map((e,t)=>(0,p.jsxs)("div",{style:{...u.suggestionItem,borderTop:t>0?"1px solid #f0f0f0":"none",paddingTop:t>0?"10px":"0",marginTop:t>0?"10px":"0"},children:[(0,p.jsx)("p",{style:u.suggestionTitle,children:e.title}),e.reasoning&&(0,p.jsx)("p",{style:u.suggestionReason,children:e.reasoning}),(0,p.jsx)(r.Button,{variant:"secondary",isSmall:!0,onClick:()=>z(e.url),children:(0,o.__)("Insert Link","contextual-link-weaver")})]},"llm-"+t))]})]})})]})}});const x=()=>(0,p.jsx)("span",{className:"dashicons dashicons-admin-links"});(0,t.registerPlugin)("link-weaver-plugin",{render:()=>{const[e,t]=(0,i.useState)(!1),[l,c]=(0,i.useState)([]),[d,g]=(0,i.useState)(""),{postContent:h,currentPostId:m,blocks:v}=(0,s.useSelect)(e=>({postContent:e("core/editor").getEditedPostContent(),currentPostId:e("core/editor").getCurrentPostId(),blocks:e("core/block-editor").getBlocks()}),[]),{replaceBlocks:k}=(0,s.useDispatch)("core/block-editor");return(0,p.jsxs)(p.Fragment,{children:[(0,p.jsx)(n.PluginSidebarMoreMenuItem,{target:"link-weaver-sidebar",icon:(0,p.jsx)(x,{}),children:(0,o.__)("Link Weaver","contextual-link-weaver")}),(0,p.jsx)(n.PluginSidebar,{name:"link-weaver-sidebar",title:(0,o.__)("Link Weaver","contextual-link-weaver"),children:(0,p.jsxs)(r.PanelBody,{title:(0,o.__)("Link Suggestions","contextual-link-weaver"),children:[(0,p.jsx)("p",{style:{fontSize:"12px",color:"#666",marginBottom:"12px"},children:(0,o.__)("Scan the entire post for up to 5 internal link suggestions, or select text and use the toolbar button for targeted search.","contextual-link-weaver")}),(0,p.jsx)(r.Button,{variant:"primary",__next40pxDefaultSize:!0,onClick:()=>{h&&0!==h.trim().length?(t(!0),g(""),c([]),a()({path:"/contextual-link-weaver/v1/suggestions",method:"POST",data:{content:h,post_id:m}}).then(e=>{c(Array.isArray(e)?e:[]),t(!1)}).catch(e=>{g(e.message||(0,o.__)("An unknown error occurred.","contextual-link-weaver")),t(!1)})):g((0,o.__)("Cannot generate suggestions for an empty post.","contextual-link-weaver"))},isBusy:e,children:e?(0,o.__)("Generating…","contextual-link-weaver"):(0,o.__)("Scan Post & Generate","contextual-link-weaver")}),e&&(0,p.jsx)(r.Spinner,{style:{marginTop:"10px"}}),d&&(0,p.jsx)("p",{style:{color:"red",marginTop:"10px",fontSize:"12px"},children:d}),l&&l.length>0&&(0,p.jsxs)("div",{style:{marginTop:"20px"},children:[(0,p.jsx)("h4",{style:{marginBottom:"10px",fontSize:"13px"},children:(0,o.__)("Suggestions:","contextual-link-weaver")}),(0,p.jsx)("ul",{style:{listStyle:"none",margin:0,padding:0},children:l.map((e,t)=>(0,p.jsxs)("li",{style:u.sidebarItem,children:[(0,p.jsxs)("p",{style:{margin:"0 0 6px 0",fontSize:"13px"},children:[(0,p.jsx)("strong",{children:(0,o.__)("Phrase:","contextual-link-weaver")}),(0,p.jsx)("br",{}),(0,p.jsxs)("em",{children:["„",e.anchor_text,"“"]})]}),(0,p.jsxs)("p",{style:{margin:"0 0 10px 0",fontSize:"12px",color:"#555"},children:[(0,p.jsx)("strong",{children:(0,o.__)("Link to:","contextual-link-weaver")}),(0,p.jsx)("br",{}),e.title]}),(0,p.jsx)(r.Button,{variant:"secondary",__next40pxDefaultSize:!0,onClick:()=>((e,t)=>{let n=!1,r=null;const o=v.map(o=>{if(n||!o.attributes.content)return o;let i="";if("string"==typeof o.attributes.content)i=o.attributes.content;else{if("object"!=typeof o.attributes.content||!o.attributes.content.originalHTML)return o;i=o.attributes.content.originalHTML}const s=`<a href="${t}" class="clw-inserted-link">${e}</a>`;if(i.includes(e)&&!i.includes(s)){const t=i.replace(e,s),l={...o.attributes,content:t};return r=o.clientId,n=!0,{...o,attributes:l}}return o});if(n&&r){const t=document.querySelector(".editor-styles-wrapper");t&&new MutationObserver((e,t)=>{const n=document.querySelector(`[data-block="${r}"]`);if(n){n.scrollIntoView({behavior:"smooth",block:"center"});const e=n.querySelector("a.clw-inserted-link");e&&(e.classList.add("clw-highlight-link"),e.classList.remove("clw-inserted-link")),t.disconnect()}}).observe(t,{childList:!0,subtree:!0}),k(v.map(e=>e.clientId),o),c(l.filter(t=>t.anchor_text!==e))}else alert(`Could not find the exact phrase "${e}" in your content.`)})(e.anchor_text,e.url),children:(0,o.__)("Insert Link","contextual-link-weaver")})]},t))})]})]})})]})}});const u={popover:{padding:"16px",minWidth:"320px",maxWidth:"420px",maxHeight:"70vh",overflowY:"auto",fontSize:"13px"},popoverHeader:{display:"flex",flexWrap:"wrap",alignItems:"baseline",gap:"6px",marginBottom:"14px",paddingBottom:"10px",borderBottom:"1px solid #e0e0e0",position:"relative",paddingRight:"24px"},popoverTitle:{fontSize:"12px",color:"#666",fontWeight:"normal"},popoverAnchor:{fontSize:"13px",fontWeight:"600",color:"#1e1e1e"},closeBtn:{position:"absolute",top:0,right:0,background:"none",border:"none",cursor:"pointer",fontSize:"14px",color:"#888",padding:"0",lineHeight:1},section:{padding:"12px",background:"#f9f9f9",borderRadius:"6px",border:"1px solid #eaeaea"},sectionHeader:{display:"flex",alignItems:"center",gap:"8px",marginBottom:"10px"},sectionLabel:{fontSize:"11px",fontWeight:"600",textTransform:"uppercase",letterSpacing:"0.5px",color:"#555"},errorText:{color:"#cc1818",fontSize:"12px",margin:"4px 0"},emptyText:{color:"#888",fontSize:"12px",margin:"4px 0"},suggestionItem:{paddingBottom:"4px"},suggestionTitle:{margin:"0 0 3px 0",fontWeight:"600",fontSize:"13px",color:"#1e1e1e"},suggestionReason:{margin:"0 0 8px 0",fontSize:"11px",color:"#888",lineHeight:"1.4"},sidebarItem:{border:"1px solid #ddd",padding:"12px",borderRadius:"4px",marginBottom:"10px"}}})();